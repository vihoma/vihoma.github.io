<?xml version="1.0" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>iBot_1.8.pl</title>
<meta http-equiv="content-type" content="text/html; charset=utf-8" />
<link rev="made" href="mailto:assp@beta.macosforge.org" />
</head>

<style type="text/css">
<!--
/* default style sheet generated by perltidy */
body {background: #FFFFFF; color: #000000}
pre { color: #000000; 
      background: #F0F0F0;
      font-family: courier;
    } 

.c  { color: #228B22;} /* comment */
.cm { color: #000000;} /* comma */
.co { color: #000000;} /* colon */
.h  { color: #CD5555; font-weight:bold;} /* here-doc-target */
.hh { color: #CD5555; font-style:italic;} /* here-doc-text */
.i  { color: #00688B;} /* identifier */
.j  { color: #CD5555; font-weight:bold;} /* label */
.k  { color: #8B008B; font-weight:bold;} /* keyword */
.m  { color: #FF0000; font-weight:bold;} /* subroutine */
.n  { color: #B452CD;} /* numeric */
.p  { color: #000000;} /* paren */
.pd { color: #228B22; font-style:italic;} /* pod-text */
.pu { color: #000000;} /* punctuation */
.q  { color: #CD5555;} /* quote */
.s  { color: #000000;} /* structure */
.sc { color: #000000;} /* semicolon */
.v  { color: #B452CD;} /* v-string */
.w  { color: #000000;} /* bareword */
-->
</style>
<body style="background-color: white">
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
     (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
       m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
         })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-39880086-1', 'inet.fi');
    ga('send', 'pageview');

    </script>
<a name="-top-"></a>
<h1>iBot_1.8.pl</h1>



<pre>#!/usr/bin/env perl

<span class="c"># iBot version 1.8, copyright Marko Vihoma.</span>
<span class="c"># iBot, an IRC-bot which comments on something said or informs on current</span>
<span class="c"># tv-shows, current weather in selected city and has a top 5 Yahoo! search.</span>
<span class="c"># Yahoo! search currently disabled, as the old API no more works.</span>
<span class="c"># Tv-shows is also currently broken and only gives an error message.</span>
<span class="c"># iBot now also keeps track if an HTTP URL has been seen by</span>
<span class="c"># it before and logs it to a file as well as gloats on old URLs.</span>

<span class="k">use</span> <span class="w">strict</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">warnings</span><span class="sc">;</span>

<span class="c">### Configuration variables</span>

<span class="c">## Basic variables for bot creation</span>
<span class="k">my</span> <span class="i">$server</span> = <span class="q">&quot;irc.blinkenshell.org&quot;</span><span class="sc">;</span>
<span class="k">my</span> <span class="i">$port</span> = <span class="q">&quot;6697&quot;</span><span class="sc">;</span>
<span class="k">my</span> <span class="i">@channels</span> = <span class="s">[</span> <span class="q">&quot;#iblink&quot;</span> <span class="s">]</span><span class="sc">;</span>
<span class="k">my</span> <span class="i">$nick</span> = <span class="q">&quot;TestiBot&quot;</span><span class="sc">;</span>
<span class="k">my</span> <span class="i">$username</span> = <span class="q">&quot;TestiBot&quot;</span><span class="sc">;</span>
<span class="k">my</span> <span class="i">$name</span> = <span class="q">&quot;Sohron&#39;s iBot for testing&quot;</span><span class="sc">;</span>
<span class="k">my</span> <span class="i">$charset</span> = <span class="q">&quot;iso-8859-15&quot;</span><span class="sc">;</span>
<span class="k">my</span> <span class="i">$ssl</span> = <span class="n">1</span><span class="sc">;</span>

<span class="c">## Put the below configurations to a separate configuration file and use</span>
<span class="c">## Config::Tiny when i have the strength :p</span>

<span class="c">## How many Yahoo! search results</span>
<span class="k">my</span> <span class="i">$yahoo_results</span> = <span class="n">5</span><span class="sc">;</span>

<span class="c">## How many messages to sleep at the first keyword</span>
<span class="k">my</span> <span class="i">$sleep</span> = <span class="n">0</span><span class="sc">;</span>

<span class="c">## Shall we taint the user pasting an old url</span>
<span class="k">my</span> <span class="i">$urlcheck_taint</span> = <span class="n">1</span><span class="sc">;</span>

<span class="c">## Files configuration</span>
<span class="c"># Log files directory</span>
<span class="k">my</span> <span class="i">$logdir</span> = <span class="q">&quot;$ENV{&#39;HOME&#39;}/log&quot;</span><span class="sc">;</span>
<span class="c"># Configuration files directory</span>
<span class="k">my</span> <span class="i">$etcdir</span> = <span class="q">&quot;$ENV{&#39;HOME&#39;}/etc/iBot&quot;</span><span class="sc">;</span>
<span class="c"># Where to log</span>
<span class="k">my</span> <span class="i">$urllog</span> = <span class="q">&quot;${logdir}/iBot_urls.log&quot;</span><span class="sc">;</span> <span class="c"># Production URL log</span>
<span class="c">#my $urllog = &quot;${logdir}/iBotDev_urls.log&quot;; # For testing</span>
<span class="c">## Where is Yahoo! application ID</span>
<span class="k">my</span> <span class="i">$yid_file</span> = <span class="q">&quot;${etcdir}/iBot_yahoo_app_ID.txt&quot;</span><span class="sc">;</span>

<span class="c">## Operators and bot controllers</span>
<span class="c"># The creator ;) has total control over iBot (reload at the moment)</span>
<span class="k">my</span> <span class="i">$creator</span> = <span class="q">&quot;Sohron&quot;</span><span class="sc">;</span>
<span class="c"># Creators password file</span>
<span class="k">my</span> <span class="i">$cpw_file</span> = <span class="q">&quot;${etcdir}/creator_password.txt&quot;</span><span class="sc">;</span>

<span class="c"># Ops hash, who have command over channels</span>
<span class="k">my</span> <span class="i">%ops</span><span class="sc">;</span>

<span class="c">## #iblink configuration</span>
<span class="c"># #iblink file</span>
<span class="i">$ops</span>{<span class="q">&quot;#iblink&quot;</span>}-&gt;[<span class="n">0</span>] = <span class="q">&quot;${etcdir}/iblink_ops.txt&quot;</span><span class="sc">;</span>

<span class="c">## Flood control</span>
<span class="c"># Flood timeout in seconds</span>
<span class="k">my</span> <span class="i">$flood_time</span> = <span class="n">10</span><span class="sc">;</span>
<span class="c"># Flood count (min $flood_count and max $flood_count*2 messages allowed in</span>
<span class="c"># $flood_time seconds)</span>
<span class="k">my</span> <span class="i">$flood_count</span> = <span class="n">15</span><span class="sc">;</span>

<span class="c">### Configuration END</span>

<span class="k">my</span> <span class="i">$starttime</span> = <span class="k">time</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>

<span class="c"># Create a new iBot object</span>
<span class="k">my</span> <span class="i">$bot</span> = <span class="w">iBot</span><span class="w">-&gt;new</span><span class="s">(</span>
	<span class="w">server</span> <span class="cm">=&gt;</span> <span class="i">$server</span><span class="cm">,</span>
	<span class="w">port</span> <span class="cm">=&gt;</span> <span class="i">$port</span><span class="cm">,</span>
	<span class="w">channels</span> <span class="cm">=&gt;</span> <span class="i">@channels</span><span class="cm">,</span>
	<span class="w">nick</span> <span class="cm">=&gt;</span> <span class="i">$nick</span><span class="cm">,</span>
	<span class="w">username</span> <span class="cm">=&gt;</span> <span class="i">$username</span><span class="cm">,</span>
	<span class="w">name</span> <span class="cm">=&gt;</span> <span class="i">$name</span><span class="cm">,</span>
	<span class="w">ircname</span> <span class="cm">=&gt;</span> <span class="i">$name</span><span class="cm">,</span>
	<span class="w">charset</span> <span class="cm">=&gt;</span> <span class="i">$charset</span><span class="cm">,</span>
	<span class="w">ssl</span> <span class="cm">=&gt;</span> <span class="i">$ssl</span><span class="cm">,</span>
    <span class="w">ops</span> <span class="cm">=&gt;</span> \<span class="i">%ops</span><span class="cm">,</span>
<span class="s">)</span><span class="sc">;</span>

<span class="c"># Run the bot</span>
<span class="i">$bot</span><span class="i">-&gt;run</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>

<span class="c"># The bot class</span>
<a name="package-iBot-"></a><span class="k">package </span><span class="i">iBot</span><span class="sc">;</span>

<span class="k">use</span> <span class="w">base</span> <span class="q">qw(Bot::BasicBot::Op)</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">LWP::UserAgent</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">Encode</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">POSIX</span><span class="sc">;</span>

<span class="c"># Version</span>
<span class="k">our</span> <span class="i">$VERSION</span> = <span class="q">&quot;1.8&quot;</span><span class="sc">;</span>
<span class="c"># How many said()-events by a nick in $flood_time seconds.</span>
<span class="k">my</span> <span class="i">$said</span><span class="sc">;</span>
<span class="c"># Yahoo Application ID</span>
<span class="k">my</span> <span class="i">$yid</span><span class="sc">;</span>
<span class="c"># Creators password</span>
<span class="k">my</span> <span class="i">$cpassword</span><span class="sc">;</span>
<span class="c"># UserAgent string</span>
<span class="k">my</span> <span class="i">$agent</span> = <span class="q">&quot;iBot/$VERSION&quot;</span><span class="sc">;</span>

<a name="init-"></a><span class="k">sub </span><span class="m">init</span> <span class="s">{</span>
  <span class="k">my</span> <span class="i">$self</span> = <span class="k">shift</span><span class="sc">;</span>
  <span class="c"># If return value is true init is succesful, and new succeeds</span>
  <span class="k">my</span> <span class="i">$ret</span> = <span class="n">1</span><span class="sc">;</span>
  <span class="k">my</span> <span class="i">$errmsg</span> = <span class="q">&quot;Couldn&#39;t open file&quot;</span><span class="sc">;</span>
  
  <span class="c"># Get the Yahoo! Application ID from file</span>
  <span class="k">my</span> <span class="i">$yidfh</span><span class="sc">;</span>
  <span class="k">open</span> <span class="i">$yidfh</span><span class="cm">,</span> <span class="q">&quot;&lt;&quot;</span><span class="cm">,</span> <span class="i">$yid_file</span> || <span class="s">(</span><span class="i">$ret</span> = <span class="n">0</span> &amp;&amp;
    <span class="k">print</span> <span class="i">STDERR</span> <span class="q">&quot;$errmsg $yid_file: $!\n&quot;</span><span class="s">)</span><span class="sc">;</span>
  <span class="k">chomp</span><span class="s">(</span><span class="i">$yid</span> = <span class="q">&lt;$yidfh&gt;</span><span class="s">)</span><span class="sc">;</span>
  <span class="k">close</span> <span class="i">$yidfh</span><span class="sc">;</span>
  
  <span class="c"># Get $creator&#39;s password from file</span>
  <span class="k">my</span> <span class="i">$cpwfh</span><span class="sc">;</span>
  <span class="k">open</span> <span class="i">$cpwfh</span><span class="cm">,</span> <span class="q">&quot;&lt;&quot;</span><span class="cm">,</span> <span class="i">$cpw_file</span> || <span class="s">(</span><span class="i">$ret</span> = <span class="n">0</span> &amp;&amp;
    <span class="k">print</span> <span class="i">STDERR</span> <span class="q">&quot;$errmsg $cpw_file: $!\n&quot;</span><span class="s">)</span><span class="sc">;</span>
  <span class="k">chomp</span><span class="s">(</span><span class="i">$cpassword</span> = <span class="q">&lt;$cpwfh&gt;</span><span class="s">)</span><span class="sc">;</span>
  <span class="k">close</span> <span class="i">$cpwfh</span><span class="sc">;</span>
  
  <span class="c"># Get ops from files</span>
  <span class="k">for</span> <span class="k">my</span> <span class="i">$channel</span> <span class="s">(</span><span class="k">keys</span> <span class="i">%ops</span><span class="s">)</span> <span class="s">{</span>
    <span class="c"># Read ops, die at failure</span>
    <span class="k">my</span> <span class="i">$chfh</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$file</span> = <span class="i">$ops</span>{<span class="i">$channel</span>}-&gt;[<span class="n">0</span>]<span class="sc">;</span>
    <span class="k">open</span> <span class="i">$chfh</span><span class="cm">,</span> <span class="q">&quot;&lt;&quot;</span><span class="cm">,</span> <span class="i">$file</span> || <span class="s">(</span><span class="i">$ret</span> = <span class="n">0</span> &amp;&amp;
      <span class="k">print</span> <span class="i">STDERR</span> <span class="q">&quot;$errmsg $file: $!\n&quot;</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">chomp</span><span class="s">(</span><span class="k">my</span> <span class="i">@array</span> = <span class="q">&lt;$chfh&gt;</span><span class="s">)</span><span class="sc">;</span>
    <span class="c"># $ops{$channel}-&gt;[1] will contain a ref to an anonymous array containing</span>
    <span class="c"># all the ops on channel $channel</span>
    <span class="i">$ops</span>{<span class="i">$channel</span>}-&gt;[<span class="n">1</span>] = <span class="s">[</span> <span class="i">@array</span> <span class="s">]</span><span class="sc">;</span>
    <span class="k">close</span> <span class="i">$chfh</span><span class="sc">;</span>
    <span class="i">$chfh</span> = <span class="k">undef</span><span class="sc">;</span>
  <span class="s">}</span>
  
  <span class="k">return</span> <span class="i">$ret</span><span class="sc">;</span>
<span class="s">}</span>

<a name="said-"></a><span class="k">sub </span><span class="m">said</span> <span class="s">{</span>
  <span class="k">my</span> <span class="i">$self</span> = <span class="k">shift</span><span class="sc">;</span>
  <span class="k">my</span> <span class="i">$message</span> = <span class="k">shift</span><span class="sc">;</span>
  <span class="k">my</span> <span class="i">$reply</span> = <span class="k">undef</span><span class="sc">;</span>
  <span class="k">my</span> <span class="i">$body</span> = <span class="i">$message</span>-&gt;{<span class="w">body</span>}<span class="sc">;</span>
  <span class="k">my</span> <span class="i">$channel</span> = <span class="i">$message</span>-&gt;{<span class="w">channel</span>}<span class="sc">;</span>
  <span class="k">my</span> <span class="i">$server</span> = <span class="i">$self</span>-&gt;{<span class="w">server</span>}<span class="sc">;</span>
  <span class="k">my</span> <span class="i">$who</span> = <span class="i">$message</span>-&gt;{<span class="w">who</span>}<span class="sc">;</span>
  <span class="k">my</span> <span class="i">$say</span> = <span class="k">undef</span><span class="sc">;</span>
  <span class="k">my</span> <span class="i">$num</span> = <span class="k">int</span><span class="s">(</span><span class="k">rand</span><span class="s">(</span><span class="n">4</span><span class="s">)</span><span class="s">)</span><span class="sc">;</span>
  
  <span class="c"># Check for flooding on local server</span>
  <span class="k">if</span> <span class="s">(</span><span class="s">(</span><span class="i">$server</span> <span class="k">eq</span> <span class="q">&quot;irc.blinkenshell.org&quot;</span> <span class="k">or</span> <span class="i">$server</span> <span class="k">eq</span> <span class="q">&quot;localhost&quot;</span><span class="s">)</span> <span class="k">and</span>
      <span class="i">$channel</span> <span class="k">ne</span> <span class="q">&quot;msg&quot;</span><span class="s">)</span> <span class="s">{</span>
	<span class="i">$said</span>-&gt;{<span class="i">$who</span>}-&gt;[<span class="n">0</span>] = <span class="k">time</span> <span class="k">unless</span><span class="s">(</span><span class="k">exists</span> <span class="i">$said</span>-&gt;{<span class="i">$who</span>}<span class="s">)</span><span class="sc">;</span>
	<span class="i">$said</span>-&gt;{<span class="i">$who</span>} = <span class="i">$self</span><span class="i">-&gt;flood</span><span class="s">(</span><span class="i">$channel</span><span class="cm">,</span> <span class="i">$who</span><span class="cm">,</span> <span class="i">$said</span>-&gt;{<span class="i">$who</span>}<span class="s">)</span><span class="sc">;</span>
  <span class="s">}</span>
  
  <span class="c"># if receiving a privmsg there may be coming something special</span>
  <span class="k">if</span> <span class="s">(</span><span class="i">$channel</span> <span class="k">eq</span> <span class="q">&quot;msg&quot;</span><span class="s">)</span> <span class="s">{</span>
	<span class="c"># Reload configurations (ops at the moment)</span>
	<span class="k">if</span> <span class="s">(</span><span class="i">$body</span> =~ <span class="q">/^reload .+$/</span><span class="s">)</span> <span class="s">{</span>
	  <span class="i">$body</span> =~ <span class="q">s/^reload (.+)/$1/</span><span class="sc">;</span>
	  <span class="i">$self</span><span class="i">-&gt;reload</span><span class="s">(</span><span class="i">$who</span><span class="cm">,</span> <span class="i">$body</span><span class="s">)</span><span class="sc">;</span>
	<span class="s">}</span>
  <span class="s">}</span>
  
  <span class="c"># Check if HTTP URL has already been posted and comment accodringly</span>
  <span class="i">$self</span><span class="i">-&gt;forkit</span><span class="s">(</span><span class="w">run</span> <span class="cm">=&gt;</span> \<span class="i">&amp;urlcheck</span><span class="cm">,</span> <span class="w">arguments</span> <span class="cm">=&gt;</span> <span class="s">[</span><span class="i">$who</span><span class="cm">,</span> <span class="i">$body</span><span class="cm">,</span> <span class="i">$channel</span><span class="s">]</span><span class="cm">,</span>
				<span class="w">body</span> <span class="cm">=&gt;</span> <span class="i">$body</span><span class="cm">,</span> <span class="w">channel</span> <span class="cm">=&gt;</span> <span class="i">$channel</span><span class="s">)</span><span class="sc">;</span>
  
  <span class="c"># Return iBot version</span>
  <span class="k">if</span> <span class="s">(</span><span class="i">$body</span> =~ <span class="q">/^!version/</span><span class="s">)</span> <span class="s">{</span>
	<span class="i">$reply</span> = <span class="i">version</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
  <span class="s">}</span>
  
  <span class="c"># Check for current weather in a selected city</span>
  <span class="k">elsif</span> <span class="s">(</span><span class="i">$body</span> =~ <span class="q">/^\!temp/</span><span class="s">)</span> <span class="s">{</span>
	<span class="i">$body</span> =~ <span class="q">s/temp (.+)/$1/</span><span class="sc">;</span>
	<span class="i">$self</span><span class="i">-&gt;forkit</span><span class="s">(</span><span class="w">run</span> <span class="cm">=&gt;</span> \<span class="i">&amp;temp</span><span class="cm">,</span> <span class="w">who</span> <span class="cm">=&gt;</span> <span class="i">$who</span><span class="cm">,</span> <span class="w">channel</span> <span class="cm">=&gt;</span> <span class="q">&#39;msg&#39;</span><span class="cm">,</span>
				  <span class="w">arguments</span> <span class="cm">=&gt;</span> <span class="s">[</span><span class="i">$body</span><span class="s">]</span><span class="s">)</span><span class="sc">;</span>
  <span class="s">}</span>

  <span class="c"># Search Yahoo!</span>
  <span class="k">elsif</span> <span class="s">(</span><span class="i">$body</span> =~ <span class="q">/^\!yahoo/</span><span class="s">)</span> <span class="s">{</span>
	<span class="c"># Does /x hurt in a search query?</span>
	<span class="i">$body</span> =~ <span class="q">s/^\!yahoo (.+)$/$1/</span><span class="sc">;</span>
	<span class="i">$self</span><span class="i">-&gt;forkit</span><span class="s">(</span><span class="w">run</span> <span class="cm">=&gt;</span> \<span class="i">&amp;yahoo</span><span class="cm">,</span> <span class="w">who</span> <span class="cm">=&gt;</span> <span class="i">$who</span><span class="cm">,</span> <span class="w">channel</span> <span class="cm">=&gt;</span> <span class="q">&#39;msg&#39;</span><span class="cm">,</span>
				  <span class="w">arguments</span> <span class="cm">=&gt;</span> <span class="s">[</span><span class="i">$body</span><span class="s">]</span><span class="s">)</span><span class="sc">;</span>
  <span class="s">}</span>
  
  <span class="c"># Get bot uptime  </span>
  <span class="k">elsif</span> <span class="s">(</span><span class="i">$body</span> =~ <span class="q">/^\!uptime$/x</span><span class="s">)</span> <span class="s">{</span>
    <span class="i">$reply</span> = <span class="i">uptime</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
  <span class="s">}</span>
  
  <span class="c"># Get bot boxes uptime</span>
  <span class="k">elsif</span> <span class="s">(</span><span class="i">$body</span> =~ <span class="q">/^\!server_uptime$/x</span><span class="s">)</span> <span class="s">{</span>
    <span class="i">$reply</span> = <span class="i">server_uptime</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
  <span class="s">}</span>
  
  <span class="c"># Get bot boxes `uname -a`</span>
  <span class="k">elsif</span> <span class="s">(</span><span class="i">$body</span> =~ <span class="q">/^\!uname$/x</span><span class="s">)</span> <span class="s">{</span>
    <span class="i">$reply</span> = <span class="i">server_version</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
  <span class="s">}</span>
  
  <span class="c"># Give help :p</span>
  <span class="k">elsif</span> <span class="s">(</span><span class="i">$body</span> =~ <span class="q">/^\!help$/x</span><span class="s">)</span> <span class="s">{</span>
	<span class="i">$reply</span> = <span class="i">help</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
  <span class="s">}</span>
  
  <span class="c"># Only comment on keywords if no !-command in first</span>
  <span class="k">elsif</span>
    <span class="s">(</span><span class="i">$body</span> !~
	 <span class="q">/^!yahoo|^!temp|^!uptime|^!server_uptime|^!uname|^!help|^!version/</span><span class="s">)</span> <span class="s">{</span>
	<span class="c"># Check for some keywords to comment on</span>
	<span class="k">if</span> <span class="s">(</span><span class="i">$body</span> =~ <span class="q">/tits|boobs/i</span><span class="s">)</span> <span class="s">{</span>
	  <span class="i">$reply</span> = <span class="q">&#39;Oh I love &quot;tits&quot; :D&#39;</span> <span class="k">if</span> <span class="s">(</span><span class="i">$num</span> == <span class="n">0</span><span class="s">)</span><span class="sc">;</span>
	  <span class="i">$reply</span> = <span class="q">&quot;Gimme some of that tittie!&quot;</span> <span class="k">if</span> <span class="s">(</span><span class="i">$num</span> == <span class="n">1</span><span class="s">)</span><span class="sc">;</span>
	  <span class="i">$reply</span> = <span class="q">&quot;Do You have tits?&quot;</span> <span class="k">if</span> <span class="s">(</span><span class="i">$num</span> == <span class="n">2</span><span class="s">)</span><span class="sc">;</span>
	  <span class="i">$reply</span> = <span class="q">&quot;What do tits look like?&quot;</span> <span class="k">if</span> <span class="s">(</span><span class="i">$num</span> == <span class="n">3</span><span class="s">)</span><span class="sc">;</span>
	<span class="s">}</span>
	
	<span class="k">elsif</span> <span class="s">(</span><span class="i">$body</span> =~ <span class="q">/openbsd/i</span><span class="s">)</span> <span class="s">{</span>
	  <span class="i">$reply</span> = <span class="q">&quot;I&#39;m running on OpenBSD too!&quot;</span> <span class="k">if</span> <span class="s">(</span><span class="i">$num</span> == <span class="n">0</span><span class="s">)</span><span class="sc">;</span>
	  <span class="i">$reply</span> = <span class="q">&quot;OpenBSD is tougher than OS X :p&quot;</span> <span class="k">if</span> <span class="s">(</span><span class="i">$num</span> == <span class="n">1</span><span class="s">)</span><span class="sc">;</span>
	  <span class="i">$reply</span> = <span class="q">&quot;Shit! OpenBSD is tough...&quot;</span> <span class="k">if</span> <span class="s">(</span><span class="i">$num</span> == <span class="n">2</span><span class="s">)</span><span class="sc">;</span>
	  <span class="i">$reply</span> = <span class="q">&quot;http://www.openbsd.org/&quot;</span> <span class="k">if</span> <span class="s">(</span><span class="i">$num</span> == <span class="n">3</span><span class="s">)</span><span class="sc">;</span>
	<span class="s">}</span>
	
	<span class="k">elsif</span> <span class="s">(</span><span class="i">$body</span> =~ <span class="q">/pussy|cunt|vagina/i</span><span class="s">)</span> <span class="s">{</span>
	  <span class="i">$reply</span> = <span class="q">&quot;Show me some pussy!&quot;</span> <span class="k">if</span> <span class="s">(</span><span class="i">$num</span> == <span class="n">0</span><span class="s">)</span><span class="sc">;</span>
	  <span class="i">$reply</span> = <span class="q">&quot;I like pussy!&quot;</span> <span class="k">if</span> <span class="s">(</span><span class="i">$num</span> == <span class="n">1</span><span class="s">)</span><span class="sc">;</span>
	  <span class="i">$reply</span> = <span class="q">&quot;I haven&#39;t come from $creator\&#39;s vagina :p&quot;</span> <span class="k">if</span> <span class="s">(</span><span class="i">$num</span> == <span class="n">2</span><span class="s">)</span><span class="sc">;</span>
	  <span class="i">$reply</span> = <span class="q">&quot;Some pussy for you and me :D&quot;</span> <span class="k">if</span> <span class="s">(</span><span class="i">$num</span> == <span class="n">3</span><span class="s">)</span><span class="sc">;</span>
	<span class="s">}</span>
	
	<span class="k">elsif</span> <span class="s">(</span><span class="i">$body</span> =~ <span class="q">/booze|alcohol/i</span><span class="s">)</span> <span class="s">{</span>
	  <span class="i">$reply</span> = <span class="q">&quot;Drink booze and everything will get better ;)&quot;</span> <span class="k">if</span>
	    <span class="s">(</span><span class="i">$num</span> == <span class="n">0</span><span class="s">)</span><span class="sc">;</span>
	  <span class="i">$reply</span> = <span class="q">&quot;Booze to the machine!&quot;</span> <span class="k">if</span> <span class="s">(</span><span class="i">$num</span> == <span class="n">1</span><span class="s">)</span><span class="sc">;</span>
	  <span class="i">$reply</span> = <span class="q">&quot;Do you have any alcohol?&quot;</span> <span class="k">if</span> <span class="s">(</span><span class="i">$num</span> == <span class="n">2</span><span class="s">)</span><span class="sc">;</span>
	  <span class="i">$reply</span> = <span class="q">&quot;Gimme some booze!&quot;</span> <span class="k">if</span> <span class="s">(</span><span class="i">$num</span> == <span class="n">3</span><span class="s">)</span><span class="sc">;</span>
	<span class="s">}</span>
	
	<span class="k">elsif</span> <span class="s">(</span><span class="i">$body</span> =~ <span class="q">/beer/i</span><span class="s">)</span> <span class="s">{</span>
	  <span class="i">$reply</span> = <span class="q">&quot;Beer to the machine!&quot;</span> <span class="k">if</span> <span class="s">(</span><span class="i">$num</span> == <span class="n">0</span><span class="s">)</span><span class="sc">;</span>
	  <span class="i">$reply</span> = <span class="q">&quot;Do you have any beer?&quot;</span> <span class="k">if</span> <span class="s">(</span><span class="i">$num</span> == <span class="n">1</span><span class="s">)</span><span class="sc">;</span>
	  <span class="i">$reply</span> = <span class="q">&quot;Pass me that blottle!&quot;</span> <span class="k">if</span> <span class="s">(</span><span class="i">$num</span> == <span class="n">2</span><span class="s">)</span><span class="sc">;</span>
	  <span class="i">$reply</span> = <span class="q">&quot;have you ever drunk beer?&quot;</span> <span class="k">if</span> <span class="s">(</span><span class="i">$num</span> == <span class="n">3</span><span class="s">)</span><span class="sc">;</span>
	<span class="s">}</span>
	
	<span class="k">elsif</span> <span class="s">(</span><span class="i">$body</span> =~ <span class="q">/apple/i</span><span class="s">)</span> <span class="s">{</span>
	  <span class="i">$reply</span> = <span class="q">&quot;My boss loves baked apples!&quot;</span> <span class="k">if</span> <span class="s">(</span><span class="i">$num</span> == <span class="n">0</span><span class="s">)</span><span class="sc">;</span>
	  <span class="i">$reply</span> = <span class="q">&quot;My boss is allergic to fresh apples :(&quot;</span> <span class="k">if</span> <span class="s">(</span><span class="i">$num</span> == <span class="n">1</span><span class="s">)</span><span class="sc">;</span>
	  <span class="i">$reply</span> = <span class="q">&quot;Apple is evil, but it still makes great products.&quot;</span> <span class="k">if</span>
	    <span class="s">(</span><span class="i">$num</span> == <span class="n">2</span><span class="s">)</span><span class="sc">;</span>
	  <span class="i">$reply</span> = <span class="q">&quot;Fuck Apple and all it&#39;s friends, whoever that is!&quot;</span> <span class="k">if</span> 
	    <span class="s">(</span><span class="i">$num</span> == <span class="n">3</span><span class="s">)</span><span class="sc">;</span>
	<span class="s">}</span>
  
  <span class="k">elsif</span> <span class="s">(</span><span class="i">$body</span> =~ <span class="q">/os x/i</span><span class="s">)</span> <span class="s">{</span>
	<span class="i">$reply</span> = <span class="q">&quot;My boss loves OS X :D&quot;</span> <span class="k">if</span> <span class="s">(</span><span class="i">$num</span> == <span class="n">0</span><span class="s">)</span><span class="sc">;</span>
	<span class="i">$reply</span> = <span class="q">&quot;OS X, the _best_ UNIX workstation OS!&quot;</span> <span class="k">if</span> <span class="s">(</span><span class="i">$num</span> == <span class="n">1</span><span class="s">)</span><span class="sc">;</span>
	<span class="i">$reply</span> = <span class="q">&quot;My boss runs OS X on his MBP :)&quot;</span> <span class="k">if</span> <span class="s">(</span><span class="i">$num</span> == <span class="n">2</span><span class="s">)</span><span class="sc">;</span>
	<span class="i">$reply</span> = <span class="q">&quot;Oh, fuck it, just run Ubuntu you geek :p&quot;</span> <span class="k">if</span> <span class="s">(</span><span class="i">$num</span> == <span class="n">3</span><span class="s">)</span><span class="sc">;</span>
  <span class="s">}</span>
  
  <span class="k">elsif</span> <span class="s">(</span><span class="i">$body</span> =~ <span class="q">/fist/i</span><span class="s">)</span> <span class="s">{</span>
	<span class="i">$reply</span> = <span class="q">&quot;$who: You want me to fist fuck you?&quot;</span> <span class="k">if</span> <span class="s">(</span><span class="i">$num</span> == <span class="n">0</span><span class="s">)</span><span class="sc">;</span>
	<span class="i">$reply</span> = <span class="q">&quot;Fist fight!&quot;</span> <span class="k">if</span> <span class="s">(</span><span class="i">$num</span> == <span class="n">1</span><span class="s">)</span><span class="sc">;</span>
	<span class="i">$reply</span> = <span class="q">&quot;Fisting looks sick :p&quot;</span> <span class="k">if</span> <span class="s">(</span><span class="i">$num</span> == <span class="n">2</span><span class="s">)</span><span class="sc">;</span>
	<span class="i">$reply</span> = <span class="q">&quot;I don&#39;t have fists :&#39;(&quot;</span> <span class="k">if</span> <span class="s">(</span><span class="i">$num</span> == <span class="n">3</span><span class="s">)</span><span class="sc">;</span>
  <span class="s">}</span>
	
  <span class="c"># Check for now playing tv-shows if iBot is addressed and said the</span>
  <span class="c"># right keyword (yte = Yle Teema, nep = Jim).</span>
  <span class="c"># Disabled because YLE&#39;s HTML has chenged...</span>
  <span class="c">#if (not $body =~ /^!yahoo|^!temp|^!reload/) {</span>
	<span class="c">#$self-&gt;forkit(run =&gt; \&amp;tvcheck,  who =&gt; $who, channel =&gt; &#39;msg&#39;,</span>
	<span class="c">#			  arguments =&gt; [&quot;tv1&quot;]) if ($body =~ /tv1/i);</span>
	<span class="c">#$self-&gt;forkit(run =&gt; \&amp;tvcheck, who =&gt; $who, channel =&gt; &#39;msg&#39;,</span>
	<span class="c">#			  arguments =&gt; [&quot;tv2&quot;]) if ($body =~ /tv2/i);</span>
	<span class="c">#$self-&gt;forkit(run =&gt; \&amp;tvcheck, who =&gt; $who, channel =&gt; &#39;msg&#39;,</span>
	<span class="c">#			  arguments =&gt; [&quot;mtv&quot;]) if ($body =~ /mtv/i);</span>
	<span class="c">#$self-&gt;forkit(run =&gt; \&amp;tvcheck, who =&gt; $who, channel =&gt; &#39;msg&#39;,</span>
	<span class="c">#			  arguments =&gt;[&quot;nel&quot;]) if ($body =~ /nel/i);</span>
	<span class="c">#$self-&gt;forkit(run =&gt; \&amp;tvcheck, who =&gt; $who, channel =&gt; &#39;msg&#39;,</span>
	<span class="c">#			  arguments =&gt; [&quot;sub&quot;]) if ($body =~ /sub/i);</span>
	<span class="c">#$self-&gt;forkit(run =&gt; \&amp;tvcheck, who =&gt; $who, channel =&gt; &#39;msg&#39;,</span>
	<span class="c">#			  arguments =&gt; [&quot;yte&quot;]) if ($body =~ /yte|teema/i);</span>
	<span class="c">#$self-&gt;forkit(run =&gt;\&amp;tvcheck, who =&gt; $who, channel =&gt; &#39;msg&#39;,</span>
	<span class="c">#			  arguments =&gt; [&quot;nep&quot;]) if ($body =~ /jim/i);</span>

	<span class="c">#if ($body =~ /^\!all/i) {</span>
	<span class="c">#  for my $tv (&quot;tv1&quot;, &quot;tv2&quot;, &quot;yte&quot;, &quot;mtv&quot;, &quot;nel&quot;, &quot;nep&quot;, &quot;sub&quot;) {</span>
	<span class="c">#	$self-&gt;forkit(run =&gt; \&amp;tvcheck, who =&gt; $who, channel =&gt; &#39;msg&#39;,</span>
	<span class="c">#				  arguments =&gt; [$tv]);</span>
	<span class="c">#  }</span>
	<span class="s">}</span>
  
  <span class="c">#$reply = undef if ($self-&gt;tick() || defined $say);</span>
  <span class="c">#$sleep =  20 if ($reply);</span>

  <span class="k">return</span> <span class="i">$reply</span><span class="sc">;</span>
<span class="s">}</span>

<a name="chanjoin-"></a><span class="k">sub </span><span class="m">chanjoin</span> <span class="s">{</span>
  <span class="k">my</span> <span class="i">$self</span> = <span class="k">shift</span><span class="sc">;</span>
  <span class="k">my</span> <span class="i">$message</span> = <span class="k">shift</span><span class="sc">;</span>
  <span class="k">my</span> <span class="i">$reply</span> = <span class="k">undef</span><span class="sc">;</span>
  <span class="k">my</span> <span class="i">$who</span> = <span class="i">$message</span>-&gt;{<span class="w">who</span>}<span class="sc">;</span>
  <span class="k">my</span> <span class="i">$channel</span> = <span class="i">$message</span>-&gt;{<span class="w">channel</span>}<span class="sc">;</span>
  <span class="k">my</span> <span class="i">$server</span> = <span class="i">$self</span>-&gt;{<span class="w">server</span>}<span class="sc">;</span>
  <span class="k">my</span> <span class="s">(</span><span class="i">$sec</span><span class="cm">,</span><span class="i">$min</span><span class="cm">,</span><span class="i">$hour</span><span class="cm">,</span><span class="i">$mday</span><span class="cm">,</span><span class="i">$mon</span><span class="cm">,</span><span class="i">$year</span><span class="cm">,</span><span class="i">$wday</span><span class="cm">,</span><span class="i">$yday</span><span class="cm">,</span><span class="i">$isdst</span><span class="s">)</span> = <span class="k">localtime</span><span class="s">(</span><span class="k">time</span><span class="s">)</span><span class="sc">;</span>
  <span class="i">$mon</span>++<span class="sc">;</span>
  <span class="i">$mon</span> = <span class="q">&quot;0$mon&quot;</span> <span class="k">if</span> <span class="s">(</span><span class="i">$mon</span> =~ <span class="q">/^\d$/x</span><span class="s">)</span><span class="sc">;</span>
  <span class="i">$min</span> = <span class="q">&quot;0$min&quot;</span> <span class="k">if</span> <span class="s">(</span><span class="i">$min</span> =~ <span class="q">/^\d$/x</span><span class="s">)</span><span class="sc">;</span>
  <span class="i">$mday</span> = <span class="q">&quot;0$mday&quot;</span> <span class="k">if</span> <span class="s">(</span><span class="i">$mday</span> =~ <span class="q">/^\d$/x</span><span class="s">)</span><span class="sc">;</span>
  <span class="i">$year</span> += <span class="n">1900</span><span class="sc">;</span>

  <span class="c"># Give ops</span>
  <span class="k">for</span> <span class="k">my</span> <span class="i">$opch</span> <span class="s">(</span><span class="k">keys</span> <span class="i">%ops</span><span class="s">)</span> <span class="s">{</span>
    <span class="k">if</span> <span class="s">(</span><span class="i">$channel</span> <span class="k">eq</span> <span class="i">$opch</span><span class="s">)</span> <span class="s">{</span>
      <span class="k">my</span> <span class="i">@array</span> = <span class="i">@</span>{ <span class="i">$ops</span>{<span class="i">$opch</span>}-&gt;[<span class="n">1</span>] }<span class="sc">;</span>
      <span class="k">for</span> <span class="k">my</span> <span class="i">$op</span> <span class="s">(</span><span class="i">@array</span><span class="s">)</span> <span class="s">{</span>
        <span class="k">if</span> <span class="s">(</span><span class="i">$who</span> <span class="k">eq</span> <span class="i">$op</span><span class="s">)</span> <span class="s">{</span>
          <span class="i">$self</span><span class="i">-&gt;mode</span><span class="s">(</span><span class="i">$channel</span><span class="cm">,</span> <span class="q">&#39;+o&#39;</span><span class="cm">,</span> <span class="i">$who</span><span class="s">)</span><span class="sc">;</span>
        <span class="s">}</span>
      <span class="s">}</span>
    <span class="s">}</span>
  <span class="s">}</span>
  
  <span class="c"># Join statistics</span>
  <span class="k">if</span> <span class="s">(</span><span class="i">$channel</span> <span class="k">eq</span> <span class="q">&quot;#iblink&quot;</span><span class="s">)</span> <span class="s">{</span>
	<span class="i">$self</span><span class="i">-&gt;log</span><span class="s">(</span><span class="q">&quot;\nJoin $channel: ${year}${mon}${mday} ${hour}:${min} $who\n&quot;</span><span class="s">)</span><span class="sc">;</span>
  <span class="s">}</span>

  <span class="c">#return 1;</span>
<span class="s">}</span>

<a name="chanpart-"></a><span class="k">sub </span><span class="m">chanpart</span> <span class="s">{</span>
  <span class="k">my</span> <span class="i">$self</span> = <span class="k">shift</span><span class="sc">;</span>
  <span class="k">my</span> <span class="i">$message</span> = <span class="k">shift</span><span class="sc">;</span>
  <span class="k">my</span> <span class="i">$reply</span> = <span class="k">undef</span><span class="sc">;</span>
  <span class="i">$reply</span> = <span class="q">&quot;The master is gone, everyone cry!&quot;</span>
	<span class="k">if</span> <span class="s">(</span><span class="i">$message</span>-&gt;{<span class="w">who</span>} <span class="k">eq</span> <span class="i">$creator</span><span class="s">)</span><span class="sc">;</span>
  <span class="k">return</span> <span class="i">$reply</span><span class="sc">;</span>
<span class="s">}</span>

<a name="kicked-"></a><span class="k">sub </span><span class="m">kicked</span> <span class="s">{</span>
  <span class="k">my</span> <span class="i">$self</span> = <span class="k">shift</span><span class="sc">;</span>
  <span class="k">my</span> <span class="i">$message</span> = <span class="k">shift</span><span class="sc">;</span>
  <span class="k">my</span> <span class="i">$reply</span> = <span class="q">&quot;hahhaa &quot;</span> . <span class="i">$message</span>-&gt;{<span class="w">who</span>} . <span class="q">&quot; got kicked :p&quot;</span><span class="sc">;</span>
  <span class="k">return</span> <span class="i">$reply</span><span class="sc">;</span>
<span class="s">}</span>

<a name="help-"></a><span class="k">sub </span><span class="m">help</span> <span class="s">{</span>
  <span class="k">my</span> <span class="i">$reply</span> = <span class="q">&quot;Say \&quot;!temp &lt;city&gt;\&quot; then you&#39;ll get the weather of that&quot;</span> .
    <span class="q">&quot; city. Say \&quot;!uptime\&quot;, and i&#39;ll tell you my uptime, &quot;</span> .
	<span class="q">&quot;\&quot;!server_uptime\&quot;, and i&#39;ll tell you the uptime of the box i&#39;m living &quot;</span> .
	<span class="q">&quot;on or \&quot;!uname\&quot;, and i&#39;ll tell you my boxes uname -a output. &quot;</span> .
	<span class="q">&quot;Also, there&#39;s some keywords to which i&#39;ll respond which you don&#39;t &quot;</span> .
	<span class="q">&quot;know ;)&quot;</span><span class="sc">;</span>

  <span class="k">return</span> <span class="i">$reply</span><span class="sc">;</span>
<span class="s">}</span>

<a name="tick-"></a><span class="k">sub </span><span class="m">tick</span> <span class="s">{</span>
  <span class="k">if</span> <span class="s">(</span><span class="i">$sleep</span><span class="s">)</span> <span class="s">{</span>
	<span class="k">return</span> --<span class="i">$sleep</span><span class="sc">;</span>
  <span class="s">}</span>

  <span class="k">return</span> <span class="n">0</span><span class="sc">;</span>
<span class="s">}</span>

<a name="reload-"></a><span class="k">sub </span><span class="m">reload</span> <span class="s">{</span>
  <span class="k">my</span> <span class="s">(</span><span class="i">$self</span><span class="cm">,</span> <span class="i">$sender</span><span class="cm">,</span> <span class="i">$password</span><span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>
  
  <span class="c"># Only $creator can initiate reload for now</span>
  <span class="k">if</span> <span class="s">(</span><span class="i">$sender</span> <span class="k">eq</span> <span class="i">$creator</span> &amp;&amp; <span class="i">$password</span> <span class="k">eq</span> <span class="i">$cpassword</span><span class="s">)</span> <span class="s">{</span>
    <span class="k">my</span> <span class="i">%changed</span><span class="sc">;</span>
    <span class="k">for</span> <span class="k">my</span> <span class="i">$opch</span> <span class="s">(</span><span class="k">keys</span> <span class="i">%ops</span><span class="s">)</span> <span class="s">{</span>
        <span class="k">my</span> <span class="i">$file</span> = <span class="i">$ops</span>{<span class="i">$opch</span>}[<span class="n">0</span>]<span class="sc">;</span>
        <span class="k">my</span> <span class="i">$opfh</span><span class="sc">;</span>
        <span class="k">if</span> <span class="s">(</span><span class="k">open</span> <span class="i">$opfh</span><span class="cm">,</span> <span class="q">&quot;&lt;&quot;</span><span class="cm">,</span> <span class="i">$file</span><span class="s">)</span> <span class="s">{</span>
          <span class="k">chomp</span><span class="s">(</span><span class="k">my</span> <span class="i">@array</span> = <span class="q">&lt;$opfh&gt;</span><span class="s">)</span><span class="sc">;</span>
          <span class="i">$ops</span>{<span class="i">$opch</span>}-&gt;[<span class="n">1</span>] = <span class="s">[</span> <span class="i">@array</span> <span class="s">]</span><span class="sc">;</span>
          <span class="k">close</span> <span class="i">$opfh</span><span class="sc">;</span>
          <span class="k">my</span> <span class="i">$count</span> = <span class="k">scalar</span> <span class="i">@array</span><span class="sc">;</span>
          <span class="i">$changed</span>{<span class="i">$opch</span>} = <span class="q">&quot;${opch}: $count ops loaded&quot;</span><span class="sc">;</span>
        <span class="s">}</span>
        <span class="k">else</span> <span class="s">{</span>
          <span class="i">$changed</span>{<span class="i">$opch</span>} = <span class="q">&quot;${opch}: Couldn&#39;t open file $file: $!&quot;</span><span class="sc">;</span>
        <span class="s">}</span>
    <span class="s">}</span>
    
    <span class="c"># Return status for each channel</span>
    <span class="k">for</span> <span class="k">my</span> <span class="i">$opch</span> <span class="s">(</span><span class="k">keys</span> <span class="i">%changed</span><span class="s">)</span> <span class="s">{</span>
      <span class="k">my</span> <span class="i">$reply</span> = <span class="i">$changed</span>{<span class="i">$opch</span>}<span class="sc">;</span>
      <span class="i">$self</span><span class="i">-&gt;say</span><span class="s">(</span><span class="w">who</span> <span class="cm">=&gt;</span> <span class="i">$sender</span><span class="cm">,</span> <span class="w">channel</span> <span class="cm">=&gt;</span> <span class="q">&quot;msg&quot;</span><span class="cm">,</span> <span class="w">body</span> <span class="cm">=&gt;</span> <span class="i">$reply</span><span class="s">)</span><span class="sc">;</span>
	  <span class="k">return</span> <span class="n">1</span><span class="sc">;</span>
    <span class="s">}</span>
  <span class="s">}</span>
  <span class="k">else</span> <span class="s">{</span>
    <span class="c"># Return that $sender is not authorized to initiate config reload</span>
    <span class="k">my</span> <span class="i">$reply</span> = <span class="q">&quot;$sender, you&#39;re not authorized to reload settings &gt;:|&quot;</span><span class="sc">;</span>
    <span class="i">$self</span><span class="i">-&gt;say</span><span class="s">(</span><span class="w">who</span> <span class="cm">=&gt;</span> <span class="i">$sender</span><span class="cm">,</span> <span class="w">channel</span> <span class="cm">=&gt;</span> <span class="q">&quot;msg&quot;</span><span class="cm">,</span> <span class="w">body</span> <span class="cm">=&gt;</span> <span class="i">$reply</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">return</span> <span class="n">0</span><span class="sc">;</span>
  <span class="s">}</span>
  
  <span class="k">return</span> <span class="n">1</span><span class="sc">;</span>
<span class="s">}</span>

<a name="uptime-"></a><span class="k">sub </span><span class="m">uptime</span> <span class="s">{</span>
  <span class="k">my</span> <span class="i">$time</span> = <span class="k">time</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
  <span class="k">my</span> <span class="i">$uptime</span> = <span class="i">$time</span> - <span class="i">$starttime</span><span class="sc">;</span>
  <span class="k">my</span> <span class="i">$days</span> = <span class="k">int</span><span class="s">(</span><span class="i">$uptime</span> / <span class="n">86400</span><span class="s">)</span><span class="sc">;</span>
  <span class="k">if</span> <span class="s">(</span><span class="i">$days</span> &lt; <span class="n">1</span><span class="s">)</span> <span class="s">{</span> <span class="i">$days</span> = <span class="n">0</span> <span class="s">}</span><span class="sc">;</span>
  <span class="k">my</span> <span class="i">$hours</span> = <span class="s">(</span><span class="s">(</span><span class="i">$uptime</span> - <span class="i">$days</span> * <span class="n">86400</span><span class="s">)</span> / <span class="n">3600</span><span class="s">)</span> % <span class="n">24</span><span class="sc">;</span>
  <span class="k">if</span> <span class="s">(</span><span class="i">$hours</span> &lt; <span class="n">1</span><span class="s">)</span> <span class="s">{</span> <span class="i">$hours</span> = <span class="n">0</span> <span class="s">}</span><span class="sc">;</span>
  <span class="k">my</span> <span class="i">$minutes</span> = <span class="s">(</span><span class="s">(</span><span class="i">$uptime</span> - <span class="i">$days</span> * <span class="n">86400</span> - <span class="i">$hours</span> * <span class="n">3600</span><span class="s">)</span> / <span class="n">60</span><span class="s">)</span> % <span class="n">60</span><span class="sc">;</span>
  <span class="k">if</span> <span class="s">(</span><span class="i">$minutes</span> &lt; <span class="n">1</span><span class="s">)</span> <span class="s">{</span> <span class="i">$minutes</span> = <span class="n">0</span> <span class="s">}</span><span class="sc">;</span>
  <span class="k">my</span> <span class="i">$seconds</span> = <span class="s">(</span><span class="i">$uptime</span> - <span class="i">$days</span> * <span class="n">86400</span> - <span class="i">$hours</span> * <span class="n">3600</span> - <span class="i">$minutes</span> * <span class="n">60</span><span class="s">)</span> % <span class="n">60</span><span class="sc">;</span>
  
  <span class="k">if</span> <span class="s">(</span><span class="i">$hours</span> &lt; <span class="n">10</span><span class="s">)</span> <span class="s">{</span> <span class="i">$hours</span> = <span class="q">&quot;0$hours&quot;</span> <span class="s">}</span><span class="sc">;</span>
  <span class="k">if</span> <span class="s">(</span><span class="i">$minutes</span> &lt; <span class="n">10</span><span class="s">)</span> <span class="s">{</span> <span class="i">$minutes</span> = <span class="q">&quot;0$minutes&quot;</span> <span class="s">}</span><span class="sc">;</span>
  <span class="k">if</span> <span class="s">(</span><span class="i">$seconds</span> &lt; <span class="n">10</span><span class="s">)</span> <span class="s">{</span> <span class="i">$seconds</span> = <span class="q">&quot;0$seconds&quot;</span> <span class="s">}</span><span class="sc">;</span>
  
  
  <span class="k">return</span> <span class="q">&quot;up &quot;</span> . <span class="i">$days</span> . <span class="q">&quot; days, &quot;</span> . <span class="i">$hours</span> . <span class="q">&quot;:&quot;</span> . <span class="i">$minutes</span> . <span class="q">&quot;:&quot;</span> . <span class="i">$seconds</span><span class="sc">;</span>
<span class="s">}</span>

<a name="server_uptime-"></a><span class="k">sub </span><span class="m">server_uptime</span> <span class="s">{</span>
  <span class="k">my</span> <span class="i">$uptime</span> = <span class="q">qx/uptime/</span><span class="sc">;</span>
  <span class="k">return</span> <span class="i">$uptime</span><span class="sc">;</span>
<span class="s">}</span>

<a name="server_version-"></a><span class="k">sub </span><span class="m">server_version</span> <span class="s">{</span>
  <span class="k">my</span> <span class="i">@uname</span> = <span class="w">POSIX::uname</span><span class="sc">;</span>
  <span class="k">my</span> <span class="i">$uname</span> = <span class="q">&quot;&quot;</span><span class="sc">;</span>
  
  <span class="k">for</span> <span class="s">(</span><span class="i">@uname</span><span class="s">)</span> <span class="s">{</span>
    <span class="i">$uname</span> .= <span class="q">&quot;$_ &quot;</span><span class="sc">;</span>
  <span class="s">}</span>
  
  <span class="k">return</span> <span class="i">$uname</span><span class="sc">;</span>
<span class="s">}</span>

<a name="tvcheck-"></a><span class="k">sub </span><span class="m">tvcheck</span> <span class="s">{</span>
  <span class="k">shift</span><span class="sc">;</span>
  <span class="c"># Temporarily not available, as Yle&#39;s HTML has changed.</span>
  <span class="k">print</span> <span class="q">&quot;This service temporarily not available :(&quot;</span><span class="sc">;</span>
  <span class="k">return</span> <span class="n">1</span><span class="sc">;</span>
  <span class="c">##</span>
  <span class="k">my</span> <span class="i">$ch</span> = <span class="k">shift</span><span class="sc">;</span>
  <span class="k">my</span> <span class="i">$content</span><span class="sc">;</span>
  <span class="k">my</span> <span class="i">$err</span> = <span class="q">&quot;${ch}: couldn&#39;t get the show :(\n&quot;</span><span class="sc">;</span>
  <span class="k">print</span> <span class="i">$err</span> <span class="k">and</span> <span class="k">return</span> <span class="n">0</span> <span class="k">if</span> <span class="s">(</span><span class="k">not</span> <span class="i">$ch</span><span class="s">)</span><span class="sc">;</span>
  
  <span class="c"># Create a new LWP useragent</span>
  <span class="k">my</span> <span class="i">$ua</span> = <span class="w">LWP::UserAgent</span><span class="w">-&gt;new</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
  <span class="c"># Set UserAgent</span>
  <span class="i">$ua</span><span class="i">-&gt;agent</span><span class="s">(</span><span class="i">$agent</span><span class="s">)</span><span class="sc">;</span>
  
  <span class="c"># Create a request</span>
  <span class="k">my</span> <span class="i">$req</span> = <span class="w">HTTP::Request</span><span class="w">-&gt;new</span><span class="s">(</span>
	  <span class="w">GET</span> <span class="cm">=&gt;</span> <span class="q">&#39;http://ohjelmaopas.yle.fi/mediaoppaat/tv-opas?groups=&#39;</span> . <span class="i">$ch</span>
	  <span class="s">)</span><span class="sc">;</span>
  
  <span class="c"># Pass request to the user agent and get a response back</span>
  <span class="k">my</span> <span class="i">$res</span> = <span class="i">$ua</span><span class="i">-&gt;request</span><span class="s">(</span><span class="i">$req</span><span class="s">)</span><span class="sc">;</span>

  <span class="c"># Check the outcome of the response</span>
  <span class="k">if</span> <span class="s">(</span><span class="i">$res</span><span class="i">-&gt;is_success</span><span class="s">)</span> <span class="s">{</span>
	<span class="i">$content</span> = <span class="i">$res</span><span class="i">-&gt;content</span><span class="sc">;</span>
  <span class="s">}</span>
  <span class="k">else</span> <span class="s">{</span>
    <span class="c">#print &quot;Yhteysvirhe!\n&quot;; # DEBUG print</span>
	<span class="k">print</span> <span class="i">$err</span><span class="sc">;</span>
	<span class="k">return</span> <span class="n">0</span><span class="sc">;</span>
  <span class="s">}</span>
  
  <span class="c"># Check $content for a line matching current shows div class tag </span>
  <span class="k">if</span> <span class="s">(</span><span class="i">$content</span> =~ <span class="q">/onair/</span><span class="s">)</span> <span class="s">{</span>
    <span class="c">#print &quot;Jottain on menossa!\n&quot;; # DEBUG print</span>
	<span class="i">$content</span> =~
	  <span class="q">s/^.+?onair.+?class=&quot;programmelink&quot;.+?&gt;(.+?)&lt;\/a&gt;&lt;\/div&gt;&lt;br \/&gt;.*$/$1/sx</span><span class="sc">;</span>
	<span class="k">print</span> <span class="i">$err</span> <span class="k">and</span> <span class="k">return</span> <span class="n">0</span> <span class="k">if</span> <span class="s">(</span><span class="i">$content</span> =~ <span class="q">/^[\s]*$/x</span><span class="s">)</span><span class="sc">;</span>
  <span class="s">}</span>
  <span class="k">else</span> <span class="s">{</span>
    <span class="c">#print &quot;Ei m&auml;ts&auml;nny!\n&quot;; # DEBUG print</span>
    <span class="k">print</span> <span class="q">&quot;${ch}: nada.\n&quot;</span><span class="sc">;</span>
    <span class="k">return</span> <span class="n">0</span><span class="sc">;</span>
  <span class="s">}</span>
  
  <span class="i">$content</span> = <span class="i">Encode::encode</span><span class="s">(</span><span class="q">&quot;iso-8859-15&quot;</span><span class="cm">,</span> <span class="i">Encode::decode_utf8</span><span class="s">(</span><span class="i">$content</span><span class="s">)</span><span class="s">)</span><span class="sc">;</span>
  <span class="k">print</span> <span class="q">&quot;${ch}: $content\n&quot;</span><span class="sc">;</span>
  <span class="k">return</span> <span class="n">1</span><span class="sc">;</span>
<span class="s">}</span>

<a name="version-"></a><span class="k">sub </span><span class="m">version</span> <span class="s">{</span>
  <span class="k">return</span> <span class="q">&quot;iBot/$VERSION\n&quot;</span><span class="sc">;</span>
<span class="s">}</span>

<a name="temp-"></a><span class="k">sub </span><span class="m">temp</span> <span class="s">{</span>
  <span class="k">shift</span><span class="sc">;</span>
  <span class="k">my</span> <span class="i">$city</span> = <span class="k">shift</span><span class="sc">;</span>
  <span class="k">my</span> <span class="i">$content</span><span class="sc">;</span>
  <span class="k">my</span> <span class="i">$int_err</span> = <span class="q">&quot;Couldn&#39;t get temperature report :(\n&quot;</span><span class="sc">;</span>
  <span class="k">my</span> <span class="i">$inf_err</span> = <span class="q">&quot;The response was malformed&quot;</span><span class="sc">;</span>
  <span class="k">my</span> <span class="i">$empty_err</span> = <span class="q">&quot;The response was empty&quot;</span><span class="sc">;</span>
  <span class="k">my</span> <span class="i">$na</span> = <span class="q">&quot;not available&quot;</span><span class="sc">;</span>

  <span class="c"># Create a new useragent</span>
  <span class="k">my</span> <span class="i">$ua</span> = <span class="w">LWP::UserAgent</span><span class="w">-&gt;new</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
  <span class="i">$ua</span><span class="i">-&gt;agent</span><span class="s">(</span><span class="i">$agent</span><span class="s">)</span><span class="sc">;</span>

  <span class="c"># Create a request</span>
  <span class="k">my</span> <span class="i">$req</span> = <span class="w">HTTP::Request</span><span class="w">-&gt;new</span><span class="s">(</span>
	  <span class="w">POST</span> <span class="cm">=&gt;</span> <span class="q">&#39;http://m.wund.com/&#39;</span> .
	  <span class="q">&#39;cgi-bin/findweather/getForecast?brand=mobile&amp;query=&#39;</span> . <span class="i">$city</span>
	  <span class="s">)</span><span class="sc">;</span>

  <span class="i">$req</span><span class="i">-&gt;content_type</span><span class="s">(</span><span class="q">&#39;application/x-www-form-urlencoded&#39;</span><span class="s">)</span><span class="sc">;</span>

  <span class="c"># Pass request to the user agent and get a response back</span>
  <span class="k">my</span> <span class="i">$res</span> = <span class="i">$ua</span><span class="i">-&gt;request</span><span class="s">(</span><span class="i">$req</span><span class="s">)</span><span class="sc">;</span>

  <span class="c"># DEBUG print</span>
  <span class="c">#print $res-&gt;content;</span>

  <span class="c"># Check the outcome of the response</span>
  <span class="k">if</span> <span class="s">(</span><span class="i">$res</span><span class="i">-&gt;is_success</span><span class="s">)</span> <span class="s">{</span>
	<span class="i">$content</span> = <span class="i">$res</span><span class="i">-&gt;content</span><span class="sc">;</span>
  <span class="s">}</span>
  <span class="k">else</span> <span class="s">{</span>
	<span class="k">print</span> <span class="i">$int_err</span><span class="sc">;</span>
	<span class="k">return</span> <span class="n">0</span><span class="sc">;</span>
  <span class="s">}</span>

  <span class="k">my</span> <span class="i">$cur_temp</span> = <span class="k">my</span> <span class="i">$windchill</span> = <span class="k">my</span> <span class="i">$sky</span> = <span class="i">$content</span><span class="sc">;</span>
  <span class="i">$cur_temp</span> =~ <span class="q">s/^.+?Temperature.+?&lt;b&gt;(-?\d+)&lt;\/b&gt;&amp;deg;C.+$/$1&deg;C/ms</span><span class="sc">;</span>
  
  <span class="k">if</span> <span class="s">(</span><span class="i">$windchill</span> =~ <span class="q">/Windchill/</span><span class="s">)</span> <span class="s">{</span>
	<span class="i">$windchill</span> =~ <span class="q">s/^.+?Windchill.+?&lt;b&gt;(-?\d+)&lt;\/b&gt;&amp;deg;C.+$/$1&deg;C/ms</span><span class="sc">;</span>
  <span class="s">}</span>
  <span class="k">else</span> <span class="s">{</span>
	<span class="i">$windchill</span> = <span class="i">$na</span><span class="sc">;</span>
  <span class="s">}</span>
  
  <span class="k">if</span> <span class="s">(</span><span class="i">$sky</span> =~ <span class="q">/&gt;Conditions&lt;/</span><span class="s">)</span> <span class="s">{</span>
	<span class="i">$sky</span> =~ <span class="q">s/^.+?Conditions.+?&lt;b&gt;([\w\s]+)&lt;\/b&gt;.+$/$1/ms</span><span class="sc">;</span>
  <span class="s">}</span>
  <span class="k">else</span> <span class="s">{</span>
	<span class="i">$sky</span> = <span class="i">$na</span><span class="sc">;</span>
  <span class="s">}</span>
  
  <span class="k">if</span> <span class="s">(</span><span class="i">$cur_temp</span> =~ <span class="q">/^[\s]$/</span><span class="s">)</span> <span class="s">{</span>
	<span class="k">print</span> <span class="q">&quot;${empty_err}\n&quot;</span><span class="sc">;</span>
	<span class="k">return</span> <span class="n">0</span><span class="sc">;</span>
  <span class="s">}</span>
  <span class="k">elsif</span> <span class="s">(</span><span class="i">$cur_temp</span> !~ <span class="q">/^-?\d+&deg;C$/</span> ||
		 <span class="s">(</span><span class="i">$windchill</span> !~ <span class="q">/^-?\d+&deg;C$/</span> &amp;&amp; <span class="i">$windchill</span> !~ <span class="q">/^$na$/</span><span class="s">)</span> ||
		 <span class="s">(</span><span class="i">$sky</span> !~ <span class="q">/^[\w\s]+$/</span> &amp;&amp; <span class="i">$sky</span> !~ <span class="q">/^$na$/</span><span class="s">)</span>
		<span class="s">)</span> <span class="s">{</span>
	<span class="k">print</span> <span class="q">&quot;${inf_err}\n&quot;</span><span class="sc">;</span>
	<span class="k">return</span> <span class="n">0</span><span class="sc">;</span>
  <span class="s">}</span>
  <span class="k">else</span> <span class="s">{</span>
    <span class="k">print</span> <span class="q">&quot;${city}\nTemperature: ${cur_temp}\n&quot;</span><span class="sc">;</span>
	<span class="k">print</span> <span class="q">&quot;Windchill: ${windchill}\n&quot;</span><span class="sc">;</span>
	<span class="k">print</span> <span class="q">&quot;Sky: ${sky}\n&quot;</span><span class="sc">;</span>
	<span class="k">print</span> <span class="q">&quot;\n&quot;</span><span class="sc">;</span>
    <span class="k">return</span> <span class="n">1</span><span class="sc">;</span>
  <span class="s">}</span>
<span class="s">}</span>

<span class="c">#sub temp {</span>
<span class="c">#  shift;</span>
<span class="c">#  my $city = shift;</span>
<span class="c">#  my $content;</span>
<span class="c">#  my $err = &quot;Couldn&#39;t get the weather :(\n&quot;;</span>
<span class="c">#  print $err and return 0 if (not $city);</span>
<span class="c">#</span>
<span class="c">#  # Create a new useragent</span>
<span class="c">#  my $ua = LWP::UserAgent-&gt;new();</span>
<span class="c">#  $ua-&gt;agent($agent);</span>
<span class="c">#</span>
<span class="c">#  # Create a request</span>
<span class="c">#  my $req = HTTP::Request-&gt;new(</span>
<span class="c">#	  POST =&gt; &#39;http://m.wund.com/&#39; .</span>
<span class="c">#	  &#39;cgi-bin/findweather/getForecast?brand=mobile&amp;query=&#39; . $city</span>
<span class="c">#	  );</span>
<span class="c">#</span>
<span class="c">#  $req-&gt;content_type(&#39;application/x-www-form-urlencoded&#39;);</span>
<span class="c">#</span>
<span class="c">#  # Pass request to the user agent and get a response back</span>
<span class="c">#  my $res = $ua-&gt;request($req);</span>
<span class="c">#</span>
<span class="c">#  # Check the outcome of the response</span>
<span class="c">#  if ($res-&gt;is_success) {</span>
<span class="c">#	$content = $res-&gt;content;</span>
<span class="c">#  }</span>
<span class="c">#  else {</span>
<span class="c">#	print $err;</span>
<span class="c">#	return 0;</span>
<span class="c">#  }</span>
<span class="c">#</span>
<span class="c">#  $content =~ s/^.+?Temperature.+?&lt;b&gt;(-?\d+)&lt;\/b&gt;&amp;deg;C.+$/$1&deg;C/msx;</span>
<span class="c">#  </span>
<span class="c">#  if ($content =~ /^[\s]$/x) {</span>
<span class="c">#	print &quot;The response was empty :(\n&quot;;</span>
<span class="c">#	return 0;</span>
<span class="c">#  }</span>
<span class="c">#  elsif (!($content =~ /^-?\d+&deg;C$/x)) {</span>
<span class="c">#	print &quot;The response was malformed :(\n&quot;;</span>
<span class="c">#	return 0;</span>
<span class="c">#  }</span>
<span class="c">#  else {</span>
<span class="c">#	print &quot;${city}: $content\n&quot;;</span>
<span class="c">#	return 1;</span>
<span class="c">#  }</span>
<span class="c">#}</span>

<a name="flood-"></a><span class="k">sub </span><span class="m">flood</span> <span class="s">{</span>
  <span class="k">my</span> <span class="s">(</span><span class="i">$self</span><span class="cm">,</span> <span class="i">$channel</span><span class="cm">,</span> <span class="i">$who</span><span class="cm">,</span> <span class="i">$times</span><span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>  
  
  <span class="k">if</span> <span class="s">(</span><span class="k">exists</span> <span class="i">$times</span>-&gt;[<span class="n">0</span>]<span class="s">)</span> <span class="s">{</span>
    <span class="k">if</span> <span class="s">(</span><span class="i">@$times</span> &gt;= <span class="i">$flood_count</span><span class="s">)</span> <span class="s">{</span>
      <span class="k">my</span> <span class="i">$secs</span> = <span class="i">$times</span>-&gt;[<span class="i">$#$times</span>] - <span class="i">$times</span>-&gt;[<span class="n">0</span>]<span class="sc">;</span>
      <span class="k">if</span> <span class="s">(</span><span class="i">$secs</span> &lt; <span class="i">$flood_time</span><span class="s">)</span> <span class="s">{</span>
        <span class="c"># DEBUG print</span>
        <span class="c">#print STDERR &quot;$who flooded in $secs seconds.\n&quot;;</span>
        <span class="c"># DEBUG END</span>
        <span class="i">$self</span><span class="i">-&gt;kick</span><span class="s">(</span><span class="i">$channel</span><span class="cm">,</span> <span class="i">$who</span><span class="cm">,</span> <span class="q">&quot;No flooding!&quot;</span><span class="s">)</span><span class="sc">;</span>
      <span class="s">}</span>
      
      <span class="k">my</span> <span class="i">@tmp</span> = <span class="s">(</span><span class="k">time</span><span class="s">)</span><span class="sc">;</span>
      <span class="k">my</span> <span class="i">$reply</span> = \<span class="i">@tmp</span><span class="sc">;</span>
      <span class="k">return</span> <span class="i">$reply</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">else</span> <span class="s">{</span>
      <span class="c"># DEBUG</span>
      <span class="c">#my $n = @$times;</span>
      <span class="c">#print STDERR &quot;$who said something $n times.\n&quot;;</span>
      <span class="c"># DEBUG END</span>
      <span class="k">push</span><span class="s">(</span><span class="i">@$times</span><span class="cm">,</span> <span class="k">time</span><span class="s">)</span><span class="sc">;</span>
      <span class="k">return</span> <span class="i">$times</span><span class="sc">;</span>
    <span class="s">}</span>
  <span class="s">}</span>
<span class="s">}</span>

<a name="yahoo-"></a><span class="k">sub </span><span class="m">yahoo</span> <span class="s">{</span>
  <span class="k">shift</span><span class="sc">;</span>
  <span class="k">print</span> <span class="q">&quot;Service temporarily unavailable.\n&quot;</span> <span class="k">and</span> <span class="k">return</span> <span class="n">0</span><span class="sc">;</span>
  <span class="k">my</span> <span class="i">$query</span> = <span class="k">shift</span><span class="sc">;</span>
  <span class="k">my</span> <span class="i">@content</span><span class="sc">;</span>
  <span class="k">my</span> <span class="i">$err</span> = <span class="q">&quot;Couldn&#39;t search :(\n&quot;</span><span class="sc">;</span>
  <span class="k">my</span> <span class="i">$noq</span> = <span class="q">&quot;Please give a search term.&quot;</span><span class="sc">;</span>
  <span class="k">print</span> <span class="i">$noq</span> <span class="k">and</span> <span class="k">return</span> <span class="n">0</span> <span class="k">if</span> <span class="k">not</span> <span class="i">$query</span><span class="sc">;</span>
  <span class="k">my</span> <span class="i">@res</span><span class="sc">;</span>
  <span class="k">my</span> <span class="i">$reply</span><span class="sc">;</span>
  <span class="k">my</span> <span class="i">$ua</span> = <span class="w">LWP::UserAgent</span><span class="w">-&gt;new</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
  <span class="i">$ua</span><span class="i">-&gt;agent</span><span class="s">(</span><span class="i">$agent</span><span class="s">)</span><span class="sc">;</span>

  <span class="k">my</span> <span class="i">$response</span> = <span class="i">$ua</span><span class="i">-&gt;get</span><span class="s">(</span>
	  <span class="q">&quot;http://search.yahooapis.com/WebSearchService/V1/webSearch?appid=&quot;</span> .
	  <span class="q">&quot;${yid}&amp;query=${query}&amp;results=${yahoo_results}&quot;</span>
	  <span class="s">)</span><span class="sc">;</span>
  
  <span class="c"># DEBUG print</span>
  <span class="k">print</span> <span class="i">$response</span><span class="i">-&gt;status_line</span> . <span class="q">&quot;\n&quot;</span><span class="sc">;</span>
  <span class="c"># DEBUG end</span>

  <span class="k">if</span> <span class="s">(</span><span class="i">$response</span><span class="i">-&gt;is_success</span><span class="s">)</span> <span class="s">{</span>
	<span class="k">my</span> <span class="i">$content</span> = <span class="i">$response</span><span class="i">-&gt;content</span><span class="sc">;</span>
	<span class="i">@content</span> = <span class="k">split</span><span class="s">(</span><span class="q">&quot;\n&quot;</span><span class="cm">,</span> <span class="i">$content</span><span class="s">)</span><span class="sc">;</span>
  <span class="s">}</span>
  <span class="k">else</span> <span class="s">{</span>
	<span class="k">print</span> <span class="i">$err</span><span class="sc">;</span>
	<span class="k">return</span> <span class="n">0</span><span class="sc">;</span>
  <span class="s">}</span>

  <span class="k">my</span> <span class="i">$n</span> = <span class="n">0</span><span class="sc">;</span>
  <span class="k">for</span> <span class="k">my</span> <span class="i">$line</span> <span class="s">(</span><span class="i">@content</span><span class="s">)</span> <span class="s">{</span>
	<span class="k">print</span> <span class="q">&quot;Sorry, but the search limit has been reached, try again in &quot;</span> .
	<span class="q">&quot;a while.\n&quot;</span> <span class="k">and</span> <span class="k">return</span> <span class="n">0</span> <span class="k">if</span> <span class="s">(</span><span class="i">$line</span> =~ <span class="q">/^&lt;Error/x</span><span class="s">)</span><span class="sc">;</span>

	<span class="k">if</span> <span class="s">(</span><span class="i">$line</span> =~ <span class="q">/&lt;Result&gt;&lt;Title&gt;/x</span><span class="s">)</span> <span class="s">{</span>
	  <span class="i">$line</span> =~ <span class="q">s/^.+?&lt;Title&gt;(.+?)&lt;\/Title&gt;.+?&lt;Url&gt;(.+?)&lt;\/Url&gt;.*$/$1 &lt;$2&gt;/x</span><span class="sc">;</span>
	  <span class="i">$res</span>[<span class="i">$n</span>++] = <span class="i">$line</span><span class="sc">;</span>
	<span class="s">}</span>
  <span class="s">}</span>

  <span class="k">if</span> <span class="s">(</span><span class="i">@res</span><span class="s">)</span> <span class="s">{</span>
	<span class="i">$reply</span> = <span class="q">&quot;1. $res[0]\n&quot;</span><span class="sc">;</span>
	<span class="k">for</span> <span class="k">my</span> <span class="i">$n</span> <span class="s">(</span><span class="n">1</span>..<span class="n">4</span><span class="s">)</span> <span class="s">{</span>
	  <span class="i">$reply</span> .= <span class="i">$n</span>++ . <span class="q">&quot;. $res[$n]\n&quot;</span><span class="sc">;</span>
	<span class="s">}</span>
	<span class="k">print</span> <span class="i">$reply</span><span class="sc">;</span>
	<span class="k">return</span> <span class="n">1</span><span class="sc">;</span>
  <span class="s">}</span>
  <span class="k">else</span> <span class="s">{</span>
	<span class="k">print</span> <span class="i">$err</span><span class="sc">;</span>
	<span class="k">return</span> <span class="n">0</span><span class="sc">;</span>
  <span class="s">}</span>
<span class="s">}</span>

<a name="urlcheck-"></a><span class="k">sub </span><span class="m">urlcheck</span> <span class="s">{</span>
  <span class="k">shift</span><span class="sc">;</span>
  <span class="k">my</span> <span class="i">$who</span> = <span class="k">shift</span><span class="sc">;</span>
  <span class="k">my</span> <span class="i">$arg</span> = <span class="k">shift</span><span class="sc">;</span>
  <span class="k">my</span> <span class="i">$nch</span> = <span class="k">shift</span><span class="sc">;</span>
  <span class="k">my</span> <span class="i">$now</span> = <span class="k">time</span><span class="sc">;</span>
  <span class="k">my</span> <span class="i">$reply</span> = <span class="k">undef</span><span class="sc">;</span>
  <span class="k">my</span> <span class="i">$line</span><span class="sc">;</span>
  <span class="k">my</span> <span class="i">$url</span><span class="sc">;</span>
  <span class="k">my</span> <span class="i">$time</span><span class="sc">;</span>
  <span class="k">my</span> <span class="i">$channel</span><span class="sc">;</span>
  <span class="k">my</span> <span class="i">$poster</span><span class="sc">;</span>
  <span class="k">my</span> <span class="i">$date</span><span class="sc">;</span>
  <span class="k">my</span> <span class="i">$is_url</span> = <span class="n">0</span><span class="sc">;</span>

  <span class="i">$is_url</span> = <span class="n">1</span> <span class="k">if</span> <span class="s">(</span><span class="i">$arg</span> =~ <span class="q">/http[s]?:\/\//x</span><span class="s">)</span><span class="sc">;</span>

  <span class="k">if</span> <span class="s">(</span><span class="i">$is_url</span><span class="s">)</span> <span class="s">{</span>
	<span class="i">$arg</span> =~ <span class="q">s/^.*?(http[s]?:\/\/\S+).*$/$1/x</span><span class="sc">;</span>
	
	<span class="k">my</span> <span class="i">$urlfh</span><span class="sc">;</span>
	<span class="k">open</span> <span class="i">$urlfh</span><span class="cm">,</span> <span class="q">&quot;&lt;&quot;</span><span class="cm">,</span> <span class="i">$urllog</span> <span class="k">or</span>
	    <span class="i">Bot::BasicBot::Op::log</span><span class="s">(</span><span class="q">&quot;Couldn&#39;t open file $urllog: $!&quot;</span><span class="s">)</span><span class="sc">;</span>
	
	<span class="k">while</span> <span class="s">(</span><span class="q">&lt;$urlfh&gt;</span><span class="s">)</span> <span class="s">{</span>
	  <span class="s">(</span><span class="i">$url</span><span class="cm">,</span> <span class="i">$time</span><span class="cm">,</span> <span class="i">$channel</span><span class="cm">,</span> <span class="i">$poster</span><span class="s">)</span> = <span class="k">split</span><span class="s">(</span><span class="q">/\|\|\|/x</span><span class="cm">,</span> <span class="i">$_</span><span class="s">)</span><span class="sc">;</span>
	  <span class="k">chomp</span> <span class="i">$poster</span><span class="sc">;</span>
	  <span class="k">if</span> <span class="s">(</span><span class="s">(</span><span class="i">$arg</span> <span class="k">eq</span> <span class="i">$url</span><span class="s">)</span> <span class="k">and</span> <span class="s">(</span><span class="i">$nch</span> <span class="k">eq</span> <span class="i">$channel</span><span class="s">)</span><span class="s">)</span> <span class="s">{</span>
		<span class="k">my</span> <span class="s">(</span><span class="i">$sec</span><span class="cm">,</span><span class="i">$min</span><span class="cm">,</span><span class="i">$hour</span><span class="cm">,</span><span class="i">$mday</span><span class="cm">,</span><span class="i">$mon</span><span class="cm">,</span><span class="i">$year</span><span class="cm">,</span><span class="i">$wday</span><span class="cm">,</span><span class="i">$yday</span><span class="cm">,</span><span class="i">$isdst</span><span class="s">)</span> =
		  <span class="k">localtime</span><span class="s">(</span><span class="i">$time</span><span class="s">)</span><span class="sc">;</span>
		<span class="i">$mon</span>++<span class="sc">;</span>
		<span class="i">$year</span> += <span class="n">1900</span><span class="sc">;</span>
		<span class="i">$date</span> = <span class="q">&quot;$mday. $mon. $year&quot;</span><span class="sc">;</span>
		
		<span class="k">if</span> <span class="s">(</span><span class="i">$urlcheck_taint</span><span class="s">)</span> <span class="s">{</span>
		  <span class="k">print</span> <span class="q">&quot;haha, old! $arg first time pasted by &quot;</span> .
		    <span class="q">&quot;$poster $date :p\n&quot;</span><span class="sc">;</span>
		<span class="s">}</span>

		<span class="k">close</span> <span class="i">$urlfh</span><span class="sc">;</span>
		<span class="i">$urlfh</span> = <span class="k">undef</span><span class="sc">;</span>
		<span class="k">return</span> <span class="n">1</span><span class="sc">;</span>
	  <span class="s">}</span>
	<span class="s">}</span>

	<span class="k">close</span> <span class="i">$urlfh</span> <span class="k">if</span> <span class="s">(</span><span class="k">defined</span> <span class="i">$urlfh</span><span class="s">)</span><span class="sc">;</span>
	<span class="k">if</span> <span class="s">(</span><span class="k">open</span> <span class="i">$urlfh</span><span class="cm">,</span> <span class="q">&quot;&gt;&gt;&quot;</span><span class="cm">,</span> <span class="i">$urllog</span><span class="s">)</span> <span class="s">{</span>
	  <span class="k">print</span> <span class="i">$urlfh</span> <span class="q">&quot;${arg}|||${now}|||${nch}|||${who}\n&quot;</span><span class="sc">;</span>
	  <span class="k">close</span> <span class="i">$urlfh</span><span class="sc">;</span>
	  <span class="k">return</span> <span class="n">1</span><span class="sc">;</span>
	<span class="s">}</span>
	<span class="k">else</span> <span class="s">{</span>
	  <span class="i">Bot::BasicBot::Op::log</span><span class="s">(</span><span class="q">&quot;Couldn&#39;t open file $urllog: $!&quot;</span><span class="s">)</span><span class="sc">;</span>
	  <span class="k">return</span> <span class="n">0</span><span class="sc">;</span>
	<span class="s">}</span>
  <span class="s">}</span>
<span class="s">}</span>

<span class="c"># Class END</span>

</pre><p></p>
<hr />
<h1><a name="name">NAME</a></h1>
<p>iBot - simple IRC bot class (this is in fact an enhanced Lokk&lt;iBot for
BlinkenIRC's #iblink channel)</p>
<p>
</p>
<hr />
<h1><a name="synopsis">SYNOPSIS</a></h1>
<pre>
 use base qw(Bot::BasicBot::Op);
 use iBot;
 
 # with all defaults
 my $bot = iBot-&gt;new( channels =&gt; [&quot;#bottest&quot;] );
 $bot-&gt;run();
 
 # with all known options
 my $bot = iBot-&gt;new(
  
   server  =&gt; &quot;irc.example.com&quot;,
   port    =&gt; &quot;6667&quot;,
   channels  =&gt; [&quot;#bottest&quot;],
   
   nick      =&gt; &quot;basicbot&quot;,
   alt_nicks =&gt; [&quot;bbot&quot;, &quot;simplebot&quot;],
   username  =&gt; &quot;bot&quot;,
   name      =&gt; &quot;Yet Another Bot&quot;,
          
   ignore_list =&gt; [qw(dipsy dadadodo laotse)],
   charset =&gt; &quot;utf-8&quot;, # charset the bot assumes the channel is using
   
   ops =&gt; \%ops, # operators hash
          
   );
 $bot-&gt;run();</pre>
<p>
</p>
<hr />
<h1><a name="description">DESCRIPTION</a></h1>
<p>iBot uses a modified Bot::BasicBot module (Bot::BasicBot::Op) to import
useful methods. It monitors for said events on connected channels and responds
as wanted. iBot also has basic opering abilities (/mode +o and /kick).</p>
<p>
</p>
<hr />
<h1><a name="overriden_methods_from_bot__basicbot__op">OVERRIDEN METHODS FROM Bot::BasicBot::Op</a></h1>
<p>
</p>
<h2><a name="init___">init( )</a></h2>
<pre>

  Initiate $yid, $cpassword  and $ops{$channel}[1] from files.</pre>
<pre>

=cut</pre>
<p>
</p>
<h2><a name="said__mess_"><code>said($mess)</code></a></h2>
<pre>
  Return an aswer for certain keywords or wait 20 messages if reply has
  just been sent on a channel (no sleep for privmsg). Now uses
  Bot::BasicBot::Op's forkit method for non-blocking tv-show, temperature and
  Yahoo! search queries.</pre>
<p>
</p>
<h2><a name="chanjoin__mess_"><code>chanjoin($mess)</code></a></h2>
<pre>
  React if someone joins a channel.</pre>
<p>
</p>
<h2><a name="chanpart__mess_"><code>chanpart($mess)</code></a></h2>
<pre>

  Send a message if $creator parts a channel (disabled by default).</pre>
<p>
</p>
<h2><a name="kicked__mess_"><code>kicked($mess)</code></a></h2>
<pre>

  Send a gloating message if someone has been kicked.</pre>
<p>
</p>
<h2><a name="help__"><code>help()</code></a></h2>
<pre>

  Send a help message if someone says &quot;!help&quot;.</pre>
<p>
</p>
<h2><a name="tick__"><code>tick()</code></a></h2>
<pre>

  The sleep/wait counter.</pre>
<p>
</p>
<h2><a name="reload__sender_"><code>reload($sender)</code></a></h2>
<pre>

  Reloads configuration files (only op files at the moment).</pre>
<pre>

=cut</pre>
<p>
</p>
<h2><a name="uptime__"><code>uptime()</code></a></h2>
<pre>
  Returns bots uptime
  
=cut</pre>
<p>
</p>
<h2><a name="server_uptime__"><code>server_uptime()</code></a></h2>
<pre>
  Returns the uptime of the box the bot is running on.</pre>
<p>
</p>
<h2><a name="server_version__"><code>server_version()</code></a></h2>
<pre>
  Returns the output of 'uname -a' on the box the bot is running on.</pre>
<p>
</p>
<hr />
<h1><a name="internal_subroutines">INTERNAL SUBROUTINES</a></h1>
<p>
</p>
<h2><a name="suboutines_are_mostly_used_by_said___through__self__forkit___">Suboutines are mostly used by <code>said()</code> through $self-&gt;<code>forkit()</code>.</a></h2>
<p>
</p>
<h2><a name="tvcheck">tvcheck</a></h2>
<pre>

  Check for whats playing on a tv-channel $ch from <a href="http://ohjelmaopas.yle.fi/">http://ohjelmaopas.yle.fi/</a>.
  Currently disabled, as YLE's HTML has changed and i'm not in the mood for
  fixing it now (maybe some sort of HTML-/XML-parser in the future)...</pre>
<p>
</p>
<h2><a name="version">version</a></h2>
<pre>

  Returns the bot's name/version.</pre>
<p>
</p>
<h2><a name="temp">temp</a></h2>
<pre>
  Report the current temperature, windchill and sky for city $city from
  <a href="http://www.wunderground.com/">http://www.wunderground.com/</a>.</pre>
<p>
</p>
<h2><a name="flood__channel___who___times_">flood($channel, $who, @times)</a></h2>
<pre>
  Check channel $channel if user $who is flooding by checking if array ref
  @times' last indexes timestamp is less than 11seconds after first indexes
  timestamp and if there have been at least $flood_count said() events in
  10s.. Kick user $who if it is flooding.
  This isn't working just as i wanted, but maybe I'll learn eventually ;)</pre>
<p>
</p>
<h2><a name="yahoo">yahoo</a></h2>
<pre>
  Ask Yahoo! search for 5 hits for terms $query. Requires a Yahoo! Application
  ID (needs registration, see <a href="http://developer.yahoo.com/faq/index.html#appid">http://developer.yahoo.com/faq/index.html#appid</a>).
  This service is also disabled for now, the old search API has been dropped,
  so should start using YQL if possible.</pre>
<p>
</p>
<h2><a name="urlcheck">urlcheck</a></h2>
<p>Check if $arg contains an HTTP URL and if so, check if it has been posted
earlier. If URL has been posted earlier, send a gloating message.</p>
<p>
</p>
<hr />
<h1><a name="author">AUTHOR</a></h1>
<p>iBot class and iBot.pl by Marko Vihoma
&lt;<a href="mailto:lokki1977@gmail.com">lokki1977@gmail.com</a>&gt;</p>
<p>
</p>
<hr />
<h1><a name="credits">CREDITS</a></h1>
<p>Bot::BasicBot is written by Tom Insam and the initial version by Mark Fowler.
Bot::BasicBot::Op is modified from Bot::BasicBot adding basic opering methods
by Marko Vihoma.</p>
<p>
</p>
<hr />
<h1><a name="system_requirements">SYSTEM REQUIREMENTS</a></h1>
<p>iBot requires Bot::BasicBot::Op and LWP to run. Bot::BasicBot::Op is based
on Bot::BasicBot, POE and POE::Component::IRC.</p>
<p>
</p>
<hr />
<h1><a name="bugs">BUGS</a></h1>
<p>tvcheck, temp and yahoo search use regular expressions to parse the HTML/XML
response so they may break if HTML/XML input changes.
<code>tvcheck()</code> and <code>yahoo()</code> are currently broken and disabled (just gives an error
message).</p>
<p>
</p>
<hr />
<h1><a name="see_also">SEE ALSO</a></h1>
<p>Bot::BasicBot::Op, Bot::BasicBot and its examples, POE, POE::Component::IRC</p>

<pre>
<a name="EOF-"></a></pre></body>

</html>
